## 项目依赖概览
- 根 POM 使用 `spring-boot-starter-parent:3.2.4` 与 `Java 21`，聚合模块：`mall-common`、`mall-security`、`mall-service`、`mall-gateway`、`mall-feign-api`、`mall-model`（pom.xml:5-9,17-21,22-29）。
- 根 POM 管理 `Spring Cloud 2023.0.1` 与 `Spring Cloud Alibaba 2023.0.1.0` 的 BOM（pom.xml:30-49）。
- `mall-service` 作为服务父模块（packaging=pom），子模块：`mall-order`、`mall-shoppingcart`、`mall-user`、`mall-product`（mall-service/pom.xml:19-24）。
- `mall-service` 统一声明依赖：`spring-boot-starter-web`、Nacos discovery/config、`knife4j-openapi3`(4.4.0)、`mybatis-plus-spring-boot3-starter`(3.5.14)、`mysql-connector-j`、`lombok`、内部模块 `mall-common`、`mall-feign-api`、`mall-model`、`spring-boot-starter-validation`（mall-service/pom.xml:26-76）。
- 子模块 `mall-user` 与 `mall-product` 继承上述依赖；注意 `mall-product` 指定 `java.version=17`，需统一到 21（mall-service/mall-product/pom.xml:28-31）。
- `mall-user` 与 `mall-product` 已启用 Nacos 配置与注册（application.yml 中 `spring.cloud.nacos.*`），并从 Nacos 引入 `mall-user/mall-product` 与 `mybatisplus` 配置（mall-service/mall-user/src/main/resources/application.yml:3-22；mall-service/mall-product/src/main/resources/application.yml:3-22）。

## 数据模型概览（来自 mall-model）
- 用户域：
  - `User`：`id`、`name`、`username`、`password`、`email`、审计字段（mall-model/src/main/java/com/luxiao/mallmodel/user/User.java:15-36）。
  - `Employee`、`Role`、`Permission`、`EmployeeRole`、`RolePermission` 基本字段与审计字段（对应文件）。
- 商品域：
  - `Spu`：`id`、`name`、`description`、`imageUrl`、`salesCount`、审计字段（mall-model/.../product/Spu.java:15-36）。
  - `Sku`：`id`、`spuId`、`price`、`stockQuantity`、`status`、`specification`、审计字段（mall-model/.../product/Sku.java:16-39）。
- 公共审计填充：`MyMetaObjectHandler` 自动填充 `createdTime/updatedTime/updatedUser`（mall-common/src/main/java/com/luxiao/mallcommon/handler/MyMetaObjectHandler.java:12-25）。

## 设计与约定
- 表命名约定：`user`、`employee`、`role`、`permission`、`employee_role`、`role_permission`、`spu`、`sku`。若与实际不符，将在实体上补充 `@TableName`。
- Mapper 放置：`com.luxiao.malluser.mapper` 与 `com.luxiao.mallproduct.mapper`；应用通过 `@MapperScan` 扫描。
- 服务层：`IService<T>` + `ServiceImpl<M,T>` 组合；必要处加 `@Transactional`。
- 接口风格：REST/JSON，统一响应包装（计划新增 `ApiResponse<T>` 于 `mall-common`）。
- 鉴权与密码：
  - 先期使用 `spring-security-crypto` 的 `BCryptPasswordEncoder` 做密码加密校验（不引入完整 Security 过滤链）。
  - `mall-security` 模块后续承载统一认证授权与网关联动。
- 文档：已引入 Knife4j，使用 OpenAPI 注解生成文档。

## 用户模块功能
1. 账号注册与登录
   - 接口：`POST /api/user/register`（用户名、密码、邮箱）；`POST /api/user/login`（用户名、密码）。
   - 逻辑：用户名唯一校验；注册时 `BCrypt` 加密存储；登录时匹配哈希。
   - 返回：掩蔽敏感字段；后续可返回简易 token（占位）。
2. 用户资料
   - `GET /api/user/{id}` 查询用户资料；`PUT /api/user/{id}` 更新 `name/email`。
3. 用户分页管理
   - `GET /api/user` 支持 `page/size/username/email` 条件分页；基于 MyBatis-Plus `Page` 与 `LambdaQueryWrapper`。
4. 角色与权限（预留基础 CRUD）
   - Mapper + Service 层完成 `Role/Permission` 与关联关系的增删查；接口可先隐藏在管理端路径，例如 `/api/admin/role` 等。

## 商品模块功能
1. SPU 管理
   - `POST /api/product/spu` 创建 SPU；`PUT /api/product/spu/{id}` 更新；`GET /api/product/spu/{id}` 查询；`DELETE /api/product/spu/{id}` 删除。
   - `GET /api/product/spu` 支持分页与条件（名称/销量范围）。
2. SKU 管理
   - `POST /api/product/sku` 创建 SKU（关联 `spuId`）；`PUT /api/product/sku/{id}` 更新；`GET /api/product/sku/{id}` 查询；`DELETE /api/product/sku/{id}` 删除。
   - `GET /api/product/spu/{spuId}/skus` 查询某 SPU 下所有 SKU。
   - 库存：`PUT /api/product/sku/{id}/stock` 增减库存；并发更新使用乐观锁或单条 `SET stock = stock + ?`（后续可引入版本号字段）。
3. 组合查询
   - `GET /api/product/spu/{id}/detail` 返回 SPU + SKUs 聚合信息。

## 技术实现要点
- 目录与代码骨架
  - `mapper`：`UserMapper/RoleMapper/.../SpuMapper/SkuMapper` 继承 `BaseMapper<T>`。
  - `service`：`UserService`(IService) + `impl/UserServiceImpl`；同理 `SpuService/SkuService`。
  - `controller`：`UserController` 与 `ProductController` 拆分为 `SpuController/SkuController` 更清晰。
  - `config`：新增 `MyBatisPlusConfig`（分页插件、`@MapperScan`）。
- DTO 与校验
  - `UserRegisterReq`、`UserLoginReq`、`UserUpdateReq`；`CreateSpuReq`、`UpdateSpuReq`、`CreateSkuReq`、`UpdateStockReq`。
  - 使用 `@NotBlank/@Email/@Positive` 等约束，结合 `@Valid`。
- 统一响应
  - 在 `mall-common` 增加轻量 `ApiResponse<T>` 与异常处理器 `GlobalExceptionHandler`。
- OpenAPI/Knife4j
  - 在控制器方法加 `@Operation/@Parameter`，模块入口或配置类启用 Knife4j UI。
- 配置
  - 补充 `@TableName`（如有必要）以匹配实际表；
  - 统一各子模块 `java.version=21`；
  - 依赖新增：`spring-security-crypto`（仅用于密码哈希）。

## 验证与测试
- 单元测试：
  - `UserServiceTests`：注册/登录/更新/分页；密码哈希与匹配校验。
  - `ProductServiceTests`：SPU/SKU CRUD、库存增减、聚合查询。
- 接口联调：
  - 启动 `mall-user` 与 `mall-product`，检查 Nacos 注册；访问 Knife4j 文档 UI 与接口。
- 数据填充与审计：
  - 验证 `MyMetaObjectHandler` 对审计字段的自动填充（创建与更新）。

## 后续可扩展
- 引入统一认证（JWT）与权限（角色/资源）到 `mall-security` 与网关；
- 商品搜索（ES）与缓存（Redis）；
- 库存扣减的并发控制（乐观锁/消息队列）。

## 计划落地的具体改动（待你确认后执行）
1. 在 `mall-user` 与 `mall-product` 下新增 mapper/service/controller/config 代码骨架与 DTO。
2. 在 `mall-model` 必要实体上补充 `@TableName` 注解以贴合真实表名（若需要）。
3. 在 `mall-common` 新增 `ApiResponse` 与全局异常处理。
4. 在 `mall-service` 父 POM 补充 `spring-security-crypto` 依赖；统一 `java.version=21`。
5. 完成上述用户与商品模块全部 REST 接口与分页、库存操作，并编写测试。

请确认以上实施计划，我将开始具体编码与实现。